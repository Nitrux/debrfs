#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2022-2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.

set -eu


# -- Set program name and version.

TOOL_NAME="debrfs"


# -- Check if running with root privileges or ask for sudo.

(( EUID != 0 )) && exec sudo -- "$0" "$@"


# -- Define the path of the debrfs configuration file.

CONFIG_FILE=/etc/debrfs.conf


# -- Print informative messages to stderr.

puts_info() {
	if [ -n "$1" ]; then
		printf "%s: \e[34mInfo:\e[0m %s\n" "$TOOL_NAME" "$*" >&2
	fi
}


# -- Print success messages to stderr.

puts_success() {
	if [ -n "$1" ]; then
		printf "%s: \e[32mSuccess:\e[0m %s\n" "$TOOL_NAME" "$*" >&2
	fi
}


# -- Print error messages to stderr.

puts_error() {
	if [ -n "$1" ]; then
		printf "%s: \e[31mError:\e[0m %b\n" "$TOOL_NAME" "$*" >&2
	fi
}


# -- Print messages or text using multiple lines to stderr.

print_message() {
    if [ $# -eq 0 ]; then
        printf "\n" >&2
    else
        printf "%s\n" "$@" >&2
    fi
}


# -- Print warning messages to stderr.

puts_warning() {
    if [ -n "$1" ]; then
        printf "%s: \e[33mWarning:\e[0m %s\n" "$TOOL_NAME" "$*" >&2
    fi
}


# -- Load and validate configuration file.

load_config() {
    if [[ ! -f $CONFIG_FILE ]]; then
        puts_error "Configuration file not found at $CONFIG_FILE"
        exit 1
    fi

    puts_info "Loading configuration from $CONFIG_FILE..."

    if grep -v '^#' "$CONFIG_FILE" | grep -v '^[[:space:]]*$' | grep -Ev '^[A-Z_][A-Z0-9_]*='; then
        puts_error "Invalid configuration file format. Only variable assignments are allowed."
        exit 1
    fi

    if grep -E '[;&|$`]' "$CONFIG_FILE" | grep -v '^#'; then
        puts_error "Configuration file contains potentially dangerous characters (;, &, |, \$, \`)."
        exit 1
    fi

    # shellcheck source=/dev/null
    . "$CONFIG_FILE"

    local required_vars=("REQUIRED_PKG" "ROOTFS_VARIANT" "ROOTFS_ARCH" "ROOTFS_SUITE" "ROOTFS_DIR" "ROOTFS_MIRROR" "TAR_FILE")
    for var in "${required_vars[@]}"; do
        if [[ -z "${!var:-}" ]]; then
            puts_error "Required variable $var is not set in configuration file."
            exit 1
        fi
    done

    puts_success "Configuration loaded successfully."
}


# -- Cleanup function to remove temporary directories.

cleanup() {
    if [[ -n "${ROOTFS_DIR:-}" ]] && [[ -d "$ROOTFS_DIR" ]] && [[ "${KEEP_ROOTFS:-false}" != "true" ]]; then
        puts_info "Cleaning up temporary directory: $ROOTFS_DIR"
        rm -rf "$ROOTFS_DIR"
    fi
}


# -- Function to create tar archive.

create_archive() {
    local tar_path="$1"
    
    puts_info "Creating compressed archive at $tar_path..."
    
    local compression_tool="${COMPRESSION_TOOL:-xz}"
    local compression_level="${COMPRESSION_LEVEL:-9}"
    
    if ! (cd "$ROOTFS_DIR" && tar -I "$compression_tool -$compression_level" -cvf "$tar_path" --exclude="var/cache/apt/archives" .); then
        puts_error "Failed to create archive."
        return 1
    fi
    
    return 0
}


# -- Function to display help message.

show_help() {
    cat <<EOF

Description:
    Create small Debian rootfs TAR files.

Report bugs at: https://github.com/Nitrux/nuts/issues.

Usage: $(basename "$0") <command>

Commands:
  create    Create and compress the root filesystem (rootfs).
  help      Display this help message.

Examples:
  sudo $(basename "$0") create
EOF
}


# -- Function to create the root filesystem.

create_rootfs() {
    puts_info "Starting root filesystem creation process..."

    local base_name="${TAR_NAME_BASE:-rootfs}"
    TAR_FILE="${base_name}-$(date +%Y.%m.%d-%H.%M).tar.xz"

    if ! dpkg -s "$REQUIRED_PKG" >/dev/null 2>&1; then
        puts_warning "Package $REQUIRED_PKG not found. Installing..."
        if ! apt -y install --no-install-recommends "$REQUIRED_PKG"; then
            puts_error "Failed to install $REQUIRED_PKG."
            exit 1
        fi
    else
        puts_info "Package $REQUIRED_PKG is already installed."
    fi

    if [[ ! -d $ROOTFS_DIR ]]; then
        puts_info "Creating rootfs directory: $ROOTFS_DIR"
        if ! mkdir -p "$ROOTFS_DIR"; then
            puts_error "Failed to create directory: $ROOTFS_DIR"
            exit 1
        fi
    else
        puts_warning "Directory exists. Cleaning: $ROOTFS_DIR"
        if ! rm -rf "$ROOTFS_DIR" || ! mkdir -p "$ROOTFS_DIR"; then
            puts_error "Failed to clean directory: $ROOTFS_DIR"
            exit 1
        fi
    fi

    puts_info "Running debootstrap (this may take a while)..."
    puts_info "Variant: $ROOTFS_VARIANT | Arch: $ROOTFS_ARCH | Suite: $ROOTFS_SUITE"
    
    local debootstrap_cmd=(
        debootstrap
        --variant="$ROOTFS_VARIANT"
        --arch="$ROOTFS_ARCH"
        --cache-dir=/tmp
    )
    
    if [[ -n "${ROOTFS_INCLUDE:-}" ]]; then
        debootstrap_cmd+=(--include="$ROOTFS_INCLUDE")
    fi
    
    if [[ -n "${ROOTFS_EXCLUDE:-}" ]]; then
        debootstrap_cmd+=(--exclude="$ROOTFS_EXCLUDE")
    fi
    
    debootstrap_cmd+=("$ROOTFS_SUITE" "$ROOTFS_DIR" "$ROOTFS_MIRROR")
    
    if ! "${debootstrap_cmd[@]}"; then
        puts_error "debootstrap failed. Check your configuration and network connection."
        exit 1
    fi

    puts_success "debootstrap completed successfully."

    local final_dir="${OUTPUT_DIR:-$PWD}"
    
    if [[ ! -d "$final_dir" ]]; then
        puts_info "Creating output directory: $final_dir"
        mkdir -p "$final_dir"
    fi

    local temp_tar_path
    temp_tar_path="$(dirname "$ROOTFS_DIR")/$(basename "$TAR_FILE")"
    
    local final_tar_path
    final_tar_path="$final_dir/$(basename "$TAR_FILE")"

    if [[ -f "$final_tar_path" ]]; then
        puts_warning "Archive already exists at $final_tar_path. Removing..."
        rm -f "$final_tar_path"
    fi

    if ! create_archive "$temp_tar_path"; then
        puts_error "Failed to create archive."
        exit 1
    fi

puts_info "Moving archive to $final_tar_path..."
    if ! mv "$temp_tar_path" "$final_tar_path"; then
         puts_error "Failed to move archive to destination."
         exit 1
    fi

    puts_success "Root filesystem archive created at $final_tar_path"
    
    if command -v du >/dev/null 2>&1;
    then
        local size
        size=$(du -h "$final_tar_path" | cut -f1)
        puts_info "Archive size: $size"
    fi
}


# -- Load configuration before setting up trap.

load_config


# -- Set up cleanup trap after configuration is loaded.

trap cleanup EXIT ERR


# -- Main script logic.

if [[ $# -eq 0 ]]; then
    puts_error "No command provided."
    show_help
    exit 1
fi

case "$1" in
    create)
        create_rootfs
        ;;
    help)
        show_help
        ;;
    *)
        puts_error "Unknown command '$1'."
        show_help
        exit 1
        ;;
esac
